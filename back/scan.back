8 "scan_IRheight" store
10 "catScan_dropHeight" store
100 "pileSwitchThreshold" store

4 "scan_catScanLimit" store
4 "scan_catPickLimit" store

leftOrRightArm "right" =
( 
-0.350000 -0.568750 0.20 -0.001554 0.999990 0.003099 -0.002801 createEEPose "workspace1" store
-0.068750 -0.712500 0.20 -0.001554 0.999990 0.003099 -0.002801 createEEPose "workspace2" store
0.281250 -0.741250 0.20 -0.001554 0.999990 0.003099 -0.002801 createEEPose  "workspace3" store
0.575000 -0.368750 0.201245 -0.001554 0.999990 0.003099 -0.002801 createEEPose "workspace4" store )
( 
leftOrRightArm "left" = 
( -0.350000 0.568750 0.20 -0.001554 0.999990 0.003099 -0.002801 createEEPose "workspace1" store
-0.068750 0.712500 0.20 -0.001554 0.999990 0.003099 -0.002801 createEEPose "workspace2" store
0.281250 0.741250 0.20 -0.001554 0.999990 0.003099 -0.002801 createEEPose  "workspace3" store
0.575000 0.368750 0.201245 -0.001554 0.999990 0.003099 -0.002801 createEEPose "workspace4" store  )
 ( "Neither left or right arm." leftOrRighArm pauseStackExecution ) 
ifte
)
ifte


workspace1 "inputPileWorkspace" store
workspace3 "playWorkspace" store
workspace4 "outputPileWorkspace" store

"catScan_" robotSerial "_" leftOrRightArm "_" dateString + + + + + "scan_catScanObjectName" store

"utils" import
"wiki" import

"clearWorkspace" import
"scene" import

(
  70 30 fixCameraLightingExposureGain
  { |B 
    0.1 "gazeDelta" store
    { |B 
      ( 1 ) ( 
	blink_lightshow 
      ) while 
    } 
    { |B 
      ( 
	playWorkspace catScan2 
      ) 5 replicateWord 
    } 
    { |B 
      ( 1 ) ( 
	drand48 -0.5 plus 4.0 times 5 setHeadPanTargetSpeed 
	drand48 20 times spinForSeconds 
	endStackCollapseNoop 
      ) while 
    } 
    { |B 
      ( 1 ) ( 
	publishWristViewToFace
      ) while 
    } 
    { |B 
      ( 1 ) ( 
	isGripperGripping ( 
	  nod 
	) ift 
      ) while 
    } 
  } ( 1 ) ( slip ) while
) "scan_threaded_catScan_wristFace" store

(
  70 30 fixCameraLightingExposureGain
  { |B 
    0.1 "gazeDelta" store
    { |B 
      ( 1 ) ( 
	blink_lightshow 
      ) while 
    } 
    { |B 
      ( 
	playWorkspace catScan2 
      ) 5 replicateWord 
    } 
    { |B 
      ( 1 ) ( 
	drand48 -0.5 plus 4.0 times 5 setHeadPanTargetSpeed 
	drand48 20 times spinForSeconds 
	endStackCollapseNoop 
      ) while 
    } 
    { |B 
      ( 1 ) ( 
	isGripperGripping ( 
	  nod 
	) ift 
      ) while 
    } 
  } ( 1 ) ( slip ) while
) "scan_threaded_catScan_noFace" store

(
  70 30 fixCameraLightingExposureGain
  { |B 
    0.1 "gazeDelta" store
    { |B 
      ( 1 ) ( 
	blink_lightshow 
      ) while 
    } 
    { |B 
      ( 
	playWorkspace catScan2 
      ) 5 replicateWord 
    } 
    { |B 
      ( 1 ) ( 
	drand48 -0.5 plus 4.0 times 5 setHeadPanTargetSpeed 
	drand48 20 times spinForSeconds 
	endStackCollapseNoop 
      ) while 
    } 
    { |B 
      ( 1 ) ( 
	30006 "gazeNumber" store
	"gaze" gazeNumber ".tif" + + publishImageFileToFace 
	gazeDelta spinForSeconds

	(
	  gazeNumber 1 + "gazeNumber" store
	  "gaze" gazeNumber ".tif" + + publishImageFileToFace 
	  gazeDelta spinForSeconds
	) 6 replicateWord

	(
	  gazeNumber -1 + "gazeNumber" store
	  "gaze" gazeNumber ".tif" + + publishImageFileToFace 
	  gazeDelta spinForSeconds
	) 5 replicateWord
	endStackCollapseNoop 
      ) while 
    } 
    { |B 
      ( 1 ) ( 
	isGripperGripping ( 
	  nod 
	) ift 
      ) while 
    } 
  } ( 1 ) ( slip ) while
) "scan_threaded_catScan_aFace" store

(
  { |B 
    ( 1 ) ( 
      drand48 -0.5 plus 4.0 times 5 setHeadPanTargetSpeed 
      drand48 20 times spinForSeconds 
      drand48 0.5 > ( 
	"ursula_yes.tif" publishImageFileToFace 
      ) ( 
	"ursula_no.tif" publishImageFileToFace 
      ) ifte 
      endStackCollapseNoop 
    ) while 
  } 
  { |B 
    ( 1 ) ( 
      30006 "gazeNumber" store
      "gaze" gazeNumber ".tif" + + publishImageFileToFace 
      gazeDelta spinForSeconds

      (
	gazeNumber 1 + "gazeNumber" store
	"gaze" gazeNumber ".tif" + + publishImageFileToFace 
	gazeDelta spinForSeconds
      ) 6 replicateWord

      (
	gazeNumber -1 + "gazeNumber" store
	"gaze" gazeNumber ".tif" + + publishImageFileToFace 
	gazeDelta spinForSeconds
      ) 5 replicateWord
      endStackCollapseNoop 
    ) while 
  } 
) "scan_thread_alterface" store

(
  clearMapForPatrol
  synchronicServo gradientServoPrep
  buildClassSimilarityMatrixFromDensity
  0.8 > (
    0.0
    " **** not a new component " print
  ) (
    1.0
    " **** is a new component " print
  ) ifte
) "scan_isNewComponent" store


(
  setIdleModeToEmpty
  openGripper
  
  ( 1 changeToHeight scan_isNewComponent ! ) (
    pickFocusedClass

    isGripperGripping (
      playWorkspace moveEeToPoseWord
      comeToStop pressUntilEffortInit 0.03 setSpeed pressUntilEffort quarterImpulse 0.01 setGridSize ( zUp ) catScan_dropHeight setMovementStateToMoving replicateWord comeToStop 
    ) ift
    openGripper

  ) while

) "scan_findNewComponent" store

(
  playWorkspace moveEeToPoseWord 
  tempUpdateBg
  playWorkspace cw_clearWorkspace
  openGripper waitUntilGripperNotMoving
  ">>>> entering pickFromInputPile <<<<" print

  ( isGripperGripping ! ) (
    /*
    endArgs "kr_dash2" setClassLabels createCachedClassifierFromClassLabels "kr_dash2" setTargetClass setPickModeToStaticMarginals
    2 setGradientServoHardMaxIterations
    2 setGradientServoSoftMaxIterations
    */
    scan_swapToBars

    0 "pileSwitchCounter" store

    ( isGripperGripping ! ) (
      ">>>> re-entering pickFromInputPile <<<<" print
      openGripper
      halfImpulse
      inputPileWorkspace moveEeToPoseWord waitUntilAtCurrentPosition
      ( perturbPosition ) 5 replicateWord 
      1 changeToHeight 
      waitUntilAtCurrentPosition
      clearMapForPatrol clearBlueBoxMemories mapLocal
      deliverTargetObject
      liftArm
      pileSwitchCounter 1 + "pileSwitchCounter" store
      pileSwitchCounter pileSwitchThreshold > ( 
	"  >>>> switching piles " print
	inputPileWorkspace "temp" store 
	outputPileWorkspace "inputPileWorkspace" store
	temp "outputPileWorkspace" store
	0 "pileSwitchCounter" store
      ) ift
    ) while

    halfImpulse
    playWorkspace moveEeToPoseWord
    waitUntilAtCurrentPosition
    ( zDown ) 15 replicateWord

    isGripperGripping ! ( playWorkspace cw_clearWorkspace ) ift 
  ) while
) "pickFromInputPile" store

( 
  ">>>> entering playWithObject <<<<" print
  comeToStop pressUntilEffortInit 0.03 setSpeed pressUntilEffort openGripper
  stay 
  0.01 setGridSize
  ( zUp ) scan_IRheight replicateWord
  comeToStop
  setScanModeCentered
  currentPose
  catScan5
) "playWithObject" store


( 
  moveEeToPoseWord
  waitUntilAtCurrentPosition

  0 "scan_pointCounter" store
  0 "scan_breakInd" store

  /* 0.01 setGridSize ( xDown ) 20 replicateWord */
  0.01 setGridSize ( xDown ) 10 replicateWord
  ( yDown ) 5 replicateWord

  ( scan_pointCounter 3 /* 4 */ <   scan_breakInd not   and ) (
    ( yUp ) 10 replicateWord
    cw_viewIsClear (
      ( yDown ) 10 replicateWord
      cw_viewIsClear (
	( xUp ) 10 replicateWord
      ) (
	1 "scan_breakInd" store
      ) ifte
    ) (
      1 "scan_breakInd" store
    ) ifte

    scan_pointCounter 1 + "scan_pointCounter" store
  ) while

  scan_breakInd
) "scan_findObjectAfterDrop_old" store

( 
  tempSwapToBlocks

  0 "scan_breakInd" store

  moveEeToPoseWord waitUntilAtCurrentPosition
  1 changeToHeight

  catScan5LoadPlayBg
  tempSpiralTakeScene
  
  "scan_findObjectAfterDrop: " print
      cw_clearWorkspace_discrepancy_thresh_val sceneCountDiscrepantCells " discrepant cells at val threshold " 
      cw_clearWorkspace_discrepancy_thresh_val " cell threshold " cw_clearWorkspace_discrepancy_thresh_cells 
    + + + +
  print

  cw_clearWorkspace_discrepancy_thresh_val sceneCountDiscrepantCells cw_clearWorkspace_discrepancy_thresh_cells < (
    "Found no object." print
    0 "scan_breakInd" store
  ) (
    "Found an object, moving to it." print
    1 "scan_breakInd" store
    tempServoToBestSceneObject waitUntilAtCurrentPosition
  ) ifte

  scan_breakInd

  tempRestoreFromBlocks
) "scan_findObjectAfterDrop" store

( 

  clearClassLabels
  setScanModeCentered

  tenthImpulse
  moveEeToPoseWord 1 changeToHeight waitUntilAtCurrentPosition
  currentPose

  0 "scan_catScanCounter" store

  "catScan_" robotSerial leftOrRightArm dateString "/" + + + + "scan_catScanObjectName" store
  scan_catScanObjectName setScanGroup
  
  scan_findObjectAfterDrop "scan_catScanSees" store
  setBoundingBoxModeToMapping
  clearMapForPatrol
  1 changeToHeight waitUntilAtCurrentPosition
  synchronicServo 

  comeToStop pressUntilEffortInit 0.03 setSpeed pressUntilEffort 
  currentPose eePosePZ "scan_gripperTouchTableZ" store

  currentPose scan_gripperTouchTableZ setEEPosePZ moveEeToPoseWord
  0.01 setGridSize ( zUp ) scan_IRheight replicateWord comeToStop 



  setPickModeToLearningAlgorithmC

  ( scan_catScanCounter 50 <   scan_catScanSees   and ) (
    currentPose

    endArgs
    currentPose
    1 changeToHeight scan_isNewComponent (
      scanObjectStreamWaypointsIR

      integrateImageStreamBufferCrops
      trainAndWriteFocusedClassKnn
      createCachedClassifierFromClassLabels

      moveEeToPoseWord
      1 changeToHeight

      setPlaceModeToHold
      pickFocusedClass

      playWorkspace moveEeToPoseWord waitUntilAtCurrentPosition

      currentPose scan_gripperTouchTableZ setEEPosePZ moveEeToPoseWord
      quarterImpulse 0.01 setGridSize ( zUp ) catScan_dropHeight replicateWord setMovementStateToMoving comeToStop 
      openGripper
    ) (
      pop pop pop

      clearMapForPatrol clearBlueBoxMemories mapLocal
      deliverTargetObject

      isGripperGripping (
	playWorkspace moveEeToPoseWord

	currentPose scan_gripperTouchTableZ setEEPosePZ moveEeToPoseWord
	quarterImpulse 0.01 setGridSize ( zUp ) catScan_dropHeight replicateWord setMovementStateToMoving comeToStop 
      ) ift
      openGripper
    ) ifte

    1 changeToHeight
    currentPose
    scan_findObjectAfterDrop "scan_catScanSees" store

    scan_catScanSees (
      setBoundingBoxModeToMapping
      clearMapForPatrol
      synchronicServo 

      currentPose scan_gripperTouchTableZ setEEPosePZ moveEeToPoseWord
      0.01 setGridSize ( zUp ) scan_IRheight replicateWord comeToStop 
    ) ift

    scan_catScanCounter 1 + "scan_catScanCounter" store
  ) while 

  setPickModeToLearningAlgorithmC
  setPlaceModeToShake

  0 "scan_catPickCounter" store
  playWorkspace moveEeToPoseWord 1 changeToHeight currentPose
  scan_findObjectAfterDrop "scan_catScanSees" store

  ( scan_catPickCounter 20 <   scan_catScanSees   and ) (
    1 changeToHeight
    clearMapForPatrol clearBlueBoxMemories
    mapLocal
    pickClosestBlueBox

    playWorkspace moveEeToPoseWord 1 changeToHeight currentPose
    scan_findObjectAfterDrop "scan_catScanSees" store
    scan_catPickCounter 1 + "scan_catPickCounter" store
  ) while

) "catScan"  store

(
  slide ( pushClassLabels 1 sP ) "scan_swap_classLabels" store
  focusedClassLabel "scan_swap_targetClass" store
  setPickModeToStaticMarginals
  /* endArgs "kr_bars/10_5_2" "kr_bars/10_5_4" "kr_bars/10_5_6" "kr_bars/10_5_8" "kr_bars/10_5_10" setClassLabels */
  endArgs "kr_bars/10_4_0" "kr_bars/10_5_2" "kr_bars/10_5_4" "kr_bars/10_5_6" "kr_bars/10_5_8" "kr_bars/10_5_10" setClassLabels
  "kr_bars/10_5_2" setTargetClass
  /* endArgs "kr_bars/10_5_6" "kr_bars/10_5_8" "kr_bars/10_5_10" setClassLabels
  "kr_bars/10_5_6" setTargetClass */
  createCachedClassifierFromClassLabels
  1 setGradientServoMode
  setGraspModeToCrane

  2 setGradientServoSoftMaxIterations 2 setGradientServoHardMaxIterations 1 setMappingServoTimeout 
) "scan_swapToBars" store

(
  endArgs scan_swap_classLabels setClassLabels 
  scan_swap_targetClass setTargetClass
  createCachedClassifierFromClassLabels
  0 setGradientServoMode
  setGraspModeTo3D
) "scan_restoreFromBars" store

(
  clearMapForPatrol

  /*
  start3dGraspAnnotationNoChange 
  c3dPoseBase "scan_catScan2_base" store 
  */
  lock3dGraspBase c3dPoseBase eePosePZ "scan_catScan2_basePZ" store
  synchronicServo
  gradientServo
  currentPose scan_catScan2_basePZ setEEPosePZ "scan_catScan2_base" store

  scan_swapToBars
  /* 
  start3dGraspAnnotationNoChange 
  */
  gradientServo
  prepareForGraspFromMemory
  currentPose scan_catScan2_basePZ pickFlushFactor + setEEPosePZ "scan_catScan2_newGrasp" store
  scan_restoreFromBars

  scan_catScan2_base setC3dPoseBase
  scan_catScan2_newGrasp add3dGraspPoseWord
  writeFocusedClass
) "scan_addBar3dGrasp" store

( 

  clearClassLabels
  setScanModeCentered
  setGraspModeTo3D

  tenthImpulse
  moveEeToPoseWord 1 changeToHeight waitUntilAtCurrentPosition
  currentPose

  0 "scan_catScanCounter" store

  "catScan_" robotSerial leftOrRightArm dateString "/" + + + + "scan_catScanObjectName" store
  scan_catScanObjectName setScanGroup
  
  scan_findObjectAfterDrop "scan_catScanSees" store
  setBoundingBoxModeToMapping
  clearMapForPatrol
  1 changeToHeight waitUntilAtCurrentPosition
  synchronicServo 


  /* comeToStop pressUntilEffortInit 0.03 setSpeed pressUntilEffort 
  currentPose eePosePZ "scan_gripperTouchTableZ" store */

  0 currentTableZ - pickFlushFactor + "scan_gripperTouchTableZ" store


  currentPose scan_gripperTouchTableZ setEEPosePZ moveEeToPoseWord
  0.01 setGridSize ( zUp ) scan_IRheight replicateWord comeToStop 



  setPickModeToLearningAlgorithmC

  ( scan_catScanCounter scan_catScanLimit <   scan_catScanSees   and ) (
    currentPose

    endArgs
    currentPose
    1 changeToHeight scan_isNewComponent (
      scanObjectStreamWaypoints3dNoPick
      playWorkspace moveEeToPoseWord

      integrateImageStreamBufferCrops
      trainAndWriteFocusedClassKnn
      createCachedClassifierFromClassLabels

      moveEeToPoseWord
      1 changeToHeight

      clearClass3dGrasps
      writeFocusedClass
      scan_addBar3dGrasp

      setPlaceModeToHold
      clearMapForPatrol
      pickFocusedClass

      playWorkspace moveEeToPoseWord waitUntilAtCurrentPosition

      isGripperGripping (
	currentPose scan_gripperTouchTableZ setEEPosePZ moveEeToPoseWord
	quarterImpulse 0.01 setGridSize ( zUp ) catScan_dropHeight replicateWord setMovementStateToMoving comeToStop 
      ) ift
      openGripper
    ) (
      pop pop pop

      /* sets the target class */
      clearMapForPatrol
      mapLocal
      clearBlueBoxMemories

      scan_addBar3dGrasp
      moveToTargetZAndGrasp
      setGridSizeCoarse departureSpeed ( zUp ) 10 replicateWord setMovementStateToMoving comeToStop

      isGripperGripping (
	playWorkspace moveEeToPoseWord

	currentPose scan_gripperTouchTableZ setEEPosePZ moveEeToPoseWord
	quarterImpulse 0.01 setGridSize ( zUp ) catScan_dropHeight replicateWord setMovementStateToMoving comeToStop 
      ) ift
      openGripper
    ) ifte

    1 changeToHeight
    currentPose
    scan_findObjectAfterDrop "scan_catScanSees" store

    scan_catScanSees (
      setBoundingBoxModeToMapping
      clearMapForPatrol
      synchronicServo 

      currentPose scan_gripperTouchTableZ setEEPosePZ moveEeToPoseWord
      0.01 setGridSize ( zUp ) scan_IRheight replicateWord comeToStop 
    ) ift

    scan_catScanCounter 1 + "scan_catScanCounter" store
  ) while 

  setPickModeToLearningAlgorithmC
  setPlaceModeToShake

  0 "scan_catPickCounter" store
  playWorkspace moveEeToPoseWord 1 changeToHeight currentPose
  scan_findObjectAfterDrop "scan_catScanSees" store

  ( scan_catPickCounter scan_catPickLimit <   scan_catScanSees   and ) (
    1 changeToHeight
    clearMapForPatrol clearBlueBoxMemories
    mapLocal
    pickClosestBlueBox

    playWorkspace moveEeToPoseWord 1 changeToHeight currentPose
    scan_findObjectAfterDrop "scan_catScanSees" store
    scan_catPickCounter 1 + "scan_catPickCounter" store
  ) while

) "catScan2"  store

(
  ( 1 ) (
    setPlaceModeToShake
    1 changeToHeight
    clearMapForPatrol clearBlueBoxMemories
    mapLocal
    pickClosestBlueBox

    playWorkspace moveEeToPoseWord 1 changeToHeight currentPose
    scan_findObjectAfterDrop "scan_catScanSees" store
    scan_catPickCounter 1 + "scan_catPickCounter" store
  ) while
) "catPlayLoop" store


(
  setPickModeToLearningAlgorithmC
  1 setSnapToFlushGrasp
  2 setGradientServoHardMaxIterations
  2 setGradientServoSoftMaxIterations

  1 "somethingsThere" store

  ( isGripperGripping ! somethingsThere and ) (
    ">>>> entering moveToOutputPile <<<<" print
    halfImpulse playWorkspace moveEeToPoseWord waitUntilAtCurrentPosition
    ( perturbPosition ) 5 replicateWord 
    openGripper
    halfImpulse
    1 changeToHeight
    setPlaceModeToHold

    playWorkspace cw_workspaceIsClear ( 0 "somethingsThere" store ) ift

    "somethingsThere: " print somethingsThere print

    1 changeToHeight
    pickFocusedClass
    isGripperGripping ( liftArm ) ( openGripper playWorkspace cw_clearWorkspace ) ifte
  ) while

  somethingsThere isGripperGripping and (
    halfImpulse outputPileWorkspace moveEeToPoseWord waitUntilAtCurrentPosition
    isGripperGripping ( comeToStop pressUntilEffortInit 0.03 setSpeed pressUntilEffort openGripper liftArm ) ift 
  ) ( openGripper ) ifte

  playWorkspace cw_clearWorkspace
) "moveToOutputPile" store

(
  1 setSnapToFlushGrasp
  2 setMapServoMode
  setPlaceModeToHold
  setBoundingBoxModeToMapping
  clearMapForPatrol
  openGripper

  ( 1 )
  (
    pickFromInputPile2
    playWithObject
    moveToOutputPile 
  ) while

) "infiniteScan" store






(
  clearClassLabels
  setGraspModeTo3D

  tenthImpulse
  moveEeToPoseWord 1 changeToHeight waitUntilAtCurrentPosition
  currentPose

  0 "scan_catScanCounter" store

  "catScan_" robotSerial leftOrRightArm dateString "/" + + + + "scan_catScanObjectName" store
  scan_catScanObjectName setScanGroup
  
  scan_findObjectAfterDrop "scan_catScanSees" store
  setBoundingBoxModeToMapping
  clearMapForPatrol
  1 changeToHeight waitUntilAtCurrentPosition
  synchronicServo 


  /* comeToStop pressUntilEffortInit 0.03 setSpeed pressUntilEffort 
  currentPose eePosePZ "scan_gripperTouchTableZ" store */

  0 currentTableZ - pickFlushFactor + "scan_gripperTouchTableZ" store


  currentPose scan_gripperTouchTableZ setEEPosePZ moveEeToPoseWord
  0.01 setGridSize ( zUp ) scan_IRheight replicateWord comeToStop 



  setPickModeToLearningAlgorithmC

  ( scan_catScanCounter scan_catScanLimit <   scan_catScanSees   and ) (
    currentPose

    endArgs
    currentPose
    1 changeToHeight scan_isNewComponent (
/*
      scanObjectStreamWaypoints3dNoPick
*/
      moveEeToPoseWord
      tempFullScan



      playWorkspace moveEeToPoseWord

      integrateImageStreamBufferCrops
      trainAndWriteFocusedClassKnn
/*
      createCachedClassifierFromClassLabels
*/

      moveEeToPoseWord
      1 changeToHeight

      clearClass3dGrasps
      writeFocusedClass
/*
      scan_addBar3dGrasp
*/
      tempAddBarGrasp

      setPlaceModeToHold
      clearMapForPatrol
/*
      pickFocusedClass
*/
      tempMapFocusedAndPick

      playWorkspace moveEeToPoseWord waitUntilAtCurrentPosition

      isGripperGripping (
	currentPose scan_gripperTouchTableZ setEEPosePZ moveEeToPoseWord
	quarterImpulse 0.01 setGridSize ( zUp ) catScan_dropHeight replicateWord setMovementStateToMoving comeToStop 
      ) ift
      openGripper
    ) (
      pop pop pop

      /* sets the target class */
      setPlaceModeToHold
      clearMapForPatrol
/*
      mapLocal
      clearBlueBoxMemories

      scan_addBar3dGrasp
      moveToTargetZAndGrasp
*/
      tempAddBarGrasp
      tempPickWithAddedGrasp


      setGridSizeCoarse departureSpeed ( zUp ) 10 replicateWord setMovementStateToMoving comeToStop

      isGripperGripping (
	playWorkspace moveEeToPoseWord

	currentPose scan_gripperTouchTableZ setEEPosePZ moveEeToPoseWord
	quarterImpulse 0.01 setGridSize ( zUp ) catScan_dropHeight replicateWord setMovementStateToMoving comeToStop 
      ) ift
      openGripper
    ) ifte

    1 changeToHeight
    currentPose
    scan_findObjectAfterDrop "scan_catScanSees" store

    scan_catScanSees (
      setBoundingBoxModeToMapping
      clearMapForPatrol
      synchronicServo 

      currentPose scan_gripperTouchTableZ setEEPosePZ moveEeToPoseWord
      0.01 setGridSize ( zUp ) scan_IRheight replicateWord comeToStop 
    ) ift

    scan_catScanCounter 1 + "scan_catScanCounter" store
  ) while 

  setPickModeToLearningAlgorithmC
  setPlaceModeToShake

  0 "scan_catPickCounter" store
  playWorkspace moveEeToPoseWord 1 changeToHeight currentPose
  scan_findObjectAfterDrop "scan_catScanSees" store

  ( scan_catPickCounter scan_catPickLimit <   scan_catScanSees   and ) (
    1 changeToHeight
    clearMapForPatrol clearBlueBoxMemories
/*
    mapLocal
    pickClosestBlueBox
*/
    tempMapFocusedAndPick

    playWorkspace moveEeToPoseWord 1 changeToHeight currentPose
    scan_findObjectAfterDrop "scan_catScanSees" store
    scan_catPickCounter 1 + "scan_catPickCounter" store
  ) while

) "catScan3" store


(
  clearClassLabels
  setGraspModeTo3D

  tenthImpulse
  moveEeToPoseWord 1 changeToHeight waitUntilAtCurrentPosition

    currentPose

    0 
  "scan_catScanCounter" store

    "catScan_" robotSerial leftOrRightArm dateString "/" + + + + 
  "scan_catScanObjectName" store

  scan_catScanObjectName setScanGroup
  
    scan_findObjectAfterDrop 
  "scan_catScanSees" store
  setBoundingBoxModeToMapping
  clearMapForPatrol
  1 changeToHeight waitUntilAtCurrentPosition

  synchronicServo 


  /* comeToStop pressUntilEffortInit 0.03 setSpeed pressUntilEffort 
  currentPose eePosePZ "scan_gripperTouchTableZ" store */

  0 currentTableZ - pickFlushFactor + "scan_gripperTouchTableZ" store


  currentPose scan_gripperTouchTableZ setEEPosePZ moveEeToPoseWord
  0.01 setGridSize ( zUp ) scan_IRheight replicateWord comeToStop 



  setPickModeToLearningAlgorithmC

  ( scan_catScanCounter scan_catScanLimit <   scan_catScanSees   and ) (

    1 changeToHeight 
    currentPose

    tempSpiralIsNewComponentNormalizedSum (

      moveEeToPoseWord
      tempFullScan

      playWorkspace moveEeToPoseWord

      integrateImageStreamBufferCrops
/*
      createCachedClassifierFromClassLabels
*/
      trainAndWriteFocusedClassKnn

      moveEeToPoseWord
      1 changeToHeight

      clearClass3dGrasps
      writeFocusedClass

      tempAddBarGrasp

      setPlaceModeToHold
      clearMapForPatrol
      tempMapFocusedAndPick

      playWorkspace moveEeToPoseWord waitUntilAtCurrentPosition

      isGripperGripping (
	currentPose scan_gripperTouchTableZ setEEPosePZ moveEeToPoseWord
	quarterImpulse 0.01 setGridSize ( zUp ) catScan_dropHeight replicateWord setMovementStateToMoving comeToStop 
      ) ift
      openGripper
    ) (
      pop pop pop

      /* sets the target class */
      setPlaceModeToHold
      clearMapForPatrol

      tempAddBarGrasp
      tempPickWithAddedGrasp

      setGridSizeCoarse departureSpeed ( zUp ) 10 replicateWord setMovementStateToMoving comeToStop

      isGripperGripping (
	playWorkspace moveEeToPoseWord

	currentPose scan_gripperTouchTableZ setEEPosePZ moveEeToPoseWord
	quarterImpulse 0.01 setGridSize ( zUp ) catScan_dropHeight replicateWord setMovementStateToMoving comeToStop 
      ) ift
      openGripper
    ) ifte

    1 changeToHeight
    currentPose
    scan_findObjectAfterDrop "scan_catScanSees" store

    scan_catScanSees (
      setBoundingBoxModeToMapping
      clearMapForPatrol
      synchronicServo 

      currentPose scan_gripperTouchTableZ setEEPosePZ moveEeToPoseWord
      0.01 setGridSize ( zUp ) scan_IRheight replicateWord comeToStop 
    ) ift

    scan_catScanCounter 1 + "scan_catScanCounter" store
  ) while 

  setPickModeToLearningAlgorithmC
  setPlaceModeToShake

  0 "scan_catPickCounter" store
  playWorkspace moveEeToPoseWord 1 changeToHeight currentPose
  scan_findObjectAfterDrop "scan_catScanSees" store

  ( scan_catPickCounter scan_catPickLimit <   scan_catScanSees   and ) (
    1 changeToHeight
    clearMapForPatrol clearBlueBoxMemories
/*
    mapLocal
    pickClosestBlueBox
*/
    tempMapFocusedAndPick

    playWorkspace moveEeToPoseWord 1 changeToHeight currentPose
    scan_findObjectAfterDrop "scan_catScanSees" store
    scan_catPickCounter 1 + "scan_catPickCounter" store
  ) while

  /*
  catScan4 currently uses new tech to perform pose estimation and configuration detection
  */
) "catScan4" store





5 "catScan5NumVarianceTrials" store
dateString "catScan5VarianceTrialBatchTime" store
dateString "catScan5VarianceTrialThisTime" store
"trial" "catScan5VarianceTrialName" store
(
  dataDirectory "/objects/" scan_catScanObjectName "/" catScan5VarianceTrialName "/" + + + + + "catScan5VarianceTrialDir" store
  catScan5VarianceTrialDir mkdirs

  "catScan5VarianceTrial BEGINNING" print

  0.1 perturbPositionScale waitUntilAtCurrentPosition

  sceneClearPredictedObjects tempUpdateMaps 

    /*  
    ( tempShortTakeScene tempServoToFocusedSceneObject waitUntilAtCurrentPosition setMovementStateToMoving comeToStop ) 3 replicateWord 
    ( tempSpiralTakeScene tempServoToFocusedSceneObject waitUntilAtCurrentPosition setMovementStateToMoving comeToStop ) 2 replicateWord  
    */
    ( tempSpiralServoToBestSceneObject waitUntilAtCurrentPosition setMovementStateToMoving comeToStop ) 3 replicateWord 

    scenePushNumSceneObjects
    1
  = 
  (
     dateString
  "catScan5VarianceTrialThisTime" store

  catScan5VarianceTrialDir "scene_" catScan5VarianceTrialBatchTime "_" catScan5VarianceTrialThisTime + + + + 
  "catScan5VarianceTrialThisFileName" store

  sceneSetAnnotatedClassNameToFocusedClass
  sceneSetPredictedClassNameToFocusedClass

    catScan5VarianceTrialThisFileName ".yml" +
  sceneSaveSceneAbsolute

  clearBlueBoxMemories 

    0 
  sceneMapSceneObject
  ) ift

  "catScan5VarianceTrial ENDING" print
) "catScan5VarianceTrial" store

( 
    /* string argument on stack */
  "catScan5VarianceTrialName" store

  halfImpulse 
  ( 
    tempShortServoToBestSceneObject waitUntilAtCurrentPosition setMovementStateToMoving comeToStop 
  ) 3 replicateWord

    currentPose 
  ( 
    catScan5VarianceTrial dup moveEeToPoseWord waitUntilAtCurrentPosition setMovementStateToMoving comeToStop 
  ) 5 replicateWord
  pop
) "catScan5VarianceTrials" store

( /* expects an eePose on the stack */
  clearClassLabels
  setGraspModeTo3D

  tenthImpulse

    /* eePose */
  moveEeToPoseWord 1 changeToHeight waitUntilAtCurrentPosition

    0 
  "scan_catScanCounter" store

    "catScan5_" robotSerial leftOrRightArm dateString "/" + + + + 
  "scan_catScanObjectName" store
    scan_catScanObjectName 
  setScanGroup
  
      currentPose
    scan_findObjectAfterDrop 
  "scan_catScanSees" store

  setBoundingBoxModeToMapping
  clearMapForPatrol
  1 changeToHeight waitUntilAtCurrentPosition

  initializeAndFocusOnTempClass
  tempRecaptureServoSpiral
  clearClassLabels

    0 currentTableZ - pickFlushFactor + 
  "scan_gripperTouchTableZ" store

      currentPose 
      scan_gripperTouchTableZ 
    setEEPosePZ 
  moveEeToPoseWord

  0.01 setGridSize 
  ( 
    zUp 
  ) scan_IRheight replicateWord 
  comeToStop 

  setPickModeToLearningAlgorithmC

  ( scan_catScanCounter scan_catScanLimit <   scan_catScanSees   and ) (

    1 changeToHeight 
    currentPose "catScan5Pos" store

    tempSpiralIsNewComponentNormalizedSum (

      catScan5Pos moveEeToPoseWord waitUntilAtCurrentPosition
      tempFullScan
      catScan5Pos moveEeToPoseWord waitUntilAtCurrentPosition

/*
      integrateImageStreamBufferCrops
*/
      createCachedClassifierFromClassLabels
      trainAndWriteFocusedClassKnn

      1 changeToHeight
      waitUntilAtCurrentPosition

      clearClass3dGrasps
      writeFocusedClass

      tempAddBlockGrasp

      setPlaceModeToHold
      clearMapForPatrol

	playWorkspace 
      moveEeToPoseWord waitUntilAtCurrentPosition

      isGripperGripping (
	currentPose scan_gripperTouchTableZ setEEPosePZ moveEeToPoseWord
	quarterImpulse 0.01 setGridSize ( zUp ) catScan_dropHeight replicateWord setMovementStateToMoving comeToStop 
      ) ift
      openGripper
    ) (

      /* sets the target class */
      setPlaceModeToHold
      clearMapForPatrol

      tempAddBlockGrasp
      setPickModeToLearningAlgorithmC

      /* tempPickWithAddedGrasp */
      tempMapFocusedAndPick

      setGridSizeCoarse departureSpeed ( zUp ) 10 replicateWord setMovementStateToMoving comeToStop

      isGripperGripping (
	playWorkspace moveEeToPoseWord

	currentPose scan_gripperTouchTableZ setEEPosePZ moveEeToPoseWord
	quarterImpulse 0.01 setGridSize ( zUp ) catScan_dropHeight replicateWord setMovementStateToMoving comeToStop 
      ) ift
      openGripper
    ) ifte

    1 changeToHeight

	currentPose
      scan_findObjectAfterDrop 
    "scan_catScanSees" store
    currentPose "catScan5Pos" store

      scan_catScanCounter 1 + 
    "scan_catScanCounter" store

  ) while 

  setPickModeToLearningAlgorithmC
  setPlaceModeToShake

    0 
  "scan_catPickCounter" store

    playWorkspace 
  moveEeToPoseWord 
  1 changeToHeight 

      currentPose
    scan_findObjectAfterDrop 
  "scan_catScanSees" store

  ( scan_catPickCounter scan_catPickLimit <   scan_catScanSees   and ) (
    1 changeToHeight
    clearMapForPatrol clearBlueBoxMemories

    dateString "catScan5VarianceTrialBatchTime" store
    ( 
      catScan5VarianceTrial 
    ) catScan5NumVarianceTrials replicateWord

    tempMapFocusedAndPick

      playWorkspace 
    moveEeToPoseWord 
    1 changeToHeight 

	currentPose
      scan_findObjectAfterDrop 
    "scan_catScanSees" store

      scan_catPickCounter 1 + 
    "scan_catPickCounter" store
  ) while

  /*
    catScan5 uses bandits over 3d grasps to select the best grasp, perform
    redundant servoing and collect data for localization and classification studies
  */
) "catScan5" store

(
  playWorkspace moveEeToPoseWord 
  catScan5UpdatePlayBg
  playWorkspace cw_clearWorkspace
  openGripper waitUntilGripperNotMoving
  ">>>> entering pickFromInputPile2 <<<<" print

  ( isGripperGripping ! ) (
    /*
    scan_swapToBars
    */
    tempSwapToBlocks

    0 "pileSwitchCounter" store

    ( isGripperGripping ! ) (
      ">>>> re-entering pickFromInputPile2 <<<<" print
      openGripper
      halfImpulse
      inputPileWorkspace moveEeToPoseWord waitUntilAtCurrentPosition
      1 changeToHeight 
      waitUntilAtCurrentPosition

      catScan5LoadInputBg
      catScan5InputPileTakeScene
      quarterImpulse
      tempServoToBestSceneObject waitUntilAtCurrentPosition
      tempMapBestAndPick
      
      /* 
	clearMapForPatrol clearBlueBoxMemories mapLocal
	deliverTargetObject
      */

      liftArm
      pileSwitchCounter 1 + "pileSwitchCounter" store
      pileSwitchCounter pileSwitchThreshold > ( 
	"  >>>> switching piles " print
	inputPileWorkspace "temp" store 
	outputPileWorkspace "inputPileWorkspace" store
	temp "outputPileWorkspace" store
	0 "pileSwitchCounter" store
      ) ift
    ) while

    halfImpulse
    playWorkspace moveEeToPoseWord
    waitUntilAtCurrentPosition
    ( zDown ) 15 replicateWord

    isGripperGripping ! ( playWorkspace cw_clearWorkspace ) ift 
  ) while
) "pickFromInputPile2" store

(
  setPickModeToLearningAlgorithmC
  1 setSnapToFlushGrasp

  1 "somethingsThere" store

  ( isGripperGripping ! somethingsThere and ) (
    ">>>> entering moveToOutputPile <<<<" print
    halfImpulse playWorkspace moveEeToPoseWord waitUntilAtCurrentPosition
    ( perturbPosition ) 5 replicateWord 
    openGripper
    halfImpulse
    1 changeToHeight
    setPlaceModeToHold

    playWorkspace moveEeToPoseWord 1 changeToHeight waitUntilAtCurrentPosition
    cw_playWorkspaceIsClear "somethingsThere" store

    "somethingsThere: " print somethingsThere print

    1 changeToHeight
    pickFocusedClass
    isGripperGripping ( liftArm ) ( openGripper playWorkspace cw_clearWorkspace ) ifte
  ) while

  somethingsThere isGripperGripping and (
    halfImpulse outputPileWorkspace moveEeToPoseWord waitUntilAtCurrentPosition
    isGripperGripping ( comeToStop pressUntilEffortInit 0.03 setSpeed pressUntilEffort openGripper liftArm ) ift 
  ) ( openGripper ) ifte

  playWorkspace cw_clearWorkspace
) "moveToOutputPile2" store

(
  inputPileWorkspace moveEeToPoseWord waitUntilAtCurrentPosition
  catScan5InputPileTakeScene
  "catScan5InputBg" "_" leftOrRightArm + + sceneSaveObservedMap
  0.05 "tempSpiralMoveSpeed" store
  catScan5LoadInputBg
  tempSpiralMoveSpeedDefault "tempSpiralMoveSpeed" store
) "catScan5UpdateInputBg" store

(
  "catScan5InputBg" "_" leftOrRightArm + + sceneLoadBackgroundMap
  tempRegularizeBackground
) "catScan5LoadInputBg" store

(
  playWorkspace moveEeToPoseWord 1 changeToHeight waitUntilAtCurrentPosition
  catScan5PlayTakeScene
  "catScan5PlayBg" "_" leftOrRightArm + + sceneSaveObservedMap
  0.05 "tempSpiralMoveSpeed" store
  catScan5LoadPlayBg
  tempSpiralMoveSpeedDefault "tempSpiralMoveSpeed" store
) "catScan5UpdatePlayBg" store

(
  "catScan5PlayBg" "_" leftOrRightArm + + sceneLoadBackgroundMap
  tempRegularizeBackground
) "catScan5LoadPlayBg" store

(
  1 5 4 tempUpdateSpiralEccentricCore tempUpdateMaps
) "catScan5InputPileTakeScene" store

(
  5 1 4 tempUpdateSpiralEccentricCore tempUpdateMaps
) "catScan5PlayTakeScene" store















